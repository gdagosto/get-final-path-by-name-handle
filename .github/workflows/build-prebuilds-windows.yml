name: Build and publish Windows prebuilds

on:
  push:
    branches:
      - main
    paths:
      - 'package.json'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-windows-prebuilds:
    runs-on: windows-latest
    strategy:
      matrix:
        node: [18,20]
        arch: [x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check package.json version changed
        id: check_version
        shell: pwsh
        run: |
          $current = Get-Content package.json -Raw | ConvertFrom-Json
          $currver = $current.version
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            Write-Host "Manual run: proceeding"
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }
          $before = '${{ github.event.before }}'
          if ($before -eq '0000000000000000000000000000000000000000') {
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }
          git fetch --no-tags --depth=2 origin ${{ github.ref }}
          try {
            $prevJson = git show $before:package.json 2>$null
            $prevver = (ConvertFrom-Json $prevJson).version
          } catch {
            $prevver = ''
          }
          Write-Host "previous version: $prevver, current version: $currver"
          if ($prevver -ne $currver) {
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
          "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: Install dependencies
        if: steps.check_version.outputs.changed == 'true'
        run: pnpm install

      - name: Build JS
        if: steps.check_version.outputs.changed == 'true'
        run: pnpm run build

      - name: Build native (napi)
        if: steps.check_version.outputs.changed == 'true'
        run: pnpm run build:rust

      - name: Determine node-abi
        id: nodeabi
        shell: pwsh
        if: steps.check_version.outputs.changed == 'true'
        run: |
          $abi = node -p "'node-v'+process.versions.modules"
          "NODE_ABI=$abi" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Collect built .node and package prebuild
        shell: pwsh
        run: |
          Write-Host "Searching for .node files..."
          $candidates = @(Get-ChildItem -Path target\release -Filter *.node -ErrorAction SilentlyContinue), @(Get-ChildItem -Path build\Release -Filter *.node -ErrorAction SilentlyContinue), @(Get-ChildItem -Path . -Filter *.node -ErrorAction SilentlyContinue)
          $built = $null
          foreach ($set in $candidates) { if ($set) { $built = $set[0].FullName; break } }
          if (-not $built) { Write-Error "No built .node found"; exit 1 }
          Write-Host "Built file: $built"

          $name = '${{ github.event.repository.name }}'
          $version = '${{ steps.check_version.outputs.version }}'
          $nodeabi = '${{ steps.nodeabi.outputs.NODE_ABI }}'
          $platform = 'win32'
          $arch = '${{ matrix.arch }}'

          $fname = "$name-$version-$nodeabi-$platform-$arch.tar.gz"
          Write-Host "Packaging as $fname"

          $tempdir = Join-Path $env:RUNNER_TEMP "prebuild_pack"
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue $tempdir
          New-Item -ItemType Directory -Path $tempdir | Out-Null
          Copy-Item -Path $built -Destination (Join-Path $tempdir 'index.node') -Force

          Push-Location $tempdir
          tar -czf (Join-Path $PWD $fname) -C $tempdir .
          $packagePath = Join-Path $tempdir $fname
          Pop-Location

          Write-Host "PACKAGE=$packagePath"
          "PACKAGE=$packagePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check_version.outputs.version }}
        if: steps.check_version.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload prebuild asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.PACKAGE }}
        if: steps.check_version.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: prebuilds-${{ matrix.node }}-${{ matrix.arch }}
          path: ${{ env.PACKAGE }}
