name: Build and publish Windows prebuilds

on:
  push:
    branches:
      - main
    paths:
      - "package.json"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-windows-prebuilds:
    runs-on: windows-latest
    strategy:
      matrix:
        node: [20, 22, 24]
        arch: [x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check package.json version changed
        id: check_version
        shell: pwsh
        run: |
          $current = Get-Content package.json -Raw | ConvertFrom-Json
          $currver = $current.version
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            Write-Host "Manual run: proceeding"
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }
          $before = '${{ github.event.before }}'
          if ($before -eq '0000000000000000000000000000000000000000') {
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
            exit 0
          }
          git fetch --no-tags --depth=2 origin ${{ github.ref }}
          try {
            $prevJson = git show $before:package.json 2>$null
            $prevver = (ConvertFrom-Json $prevJson).version
          } catch {
            $prevver = ''
          }
          Write-Host "previous version: $prevver, current version: $currver"
          if ($prevver -ne $currver) {
            "changed=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "changed=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
          "version=$currver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: Install dependencies
        if: steps.check_version.outputs.changed == 'true'
        run: |
          pnpm config set auto-install-peers false
          pnpm install

      - name: Build JS
        if: steps.check_version.outputs.changed == 'true'
        run: pnpm run build

      - name: Build native (napi)
        if: steps.check_version.outputs.changed == 'true'
        run: pnpm run build:rust

      - name: Determine node-abi
        id: nodeabi
        shell: pwsh
        if: steps.check_version.outputs.changed == 'true'
        run: |
          $abi = node -p "'node-v'+process.versions.modules"
          "NODE_ABI=$abi" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Collect built .node and package prebuild
        shell: pwsh
        run: |
          $pkg = "get-final-path-by-name-handle-${{ steps.check_version.outputs.version }}-node-v${{ env.ABI }}-win32-${{ matrix.arch }}.tar.gz"
          Remove-Item -Recurse -Force prepack -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path prepack | Out-Null
          # copy single .node to prepack root and name it index.node
          $nodeFile = Get-ChildItem -Path . -Filter *.node -Recurse | Select-Object -First 1
          if (-not $nodeFile) { Write-Error "No .node built"; exit 1 }
          Copy-Item $nodeFile.FullName -Destination (Join-Path $PWD prepack\index.node) -Force
          # create a tar.gz that contains index.node at the archive root
          tar -C prepack -czf $pkg index.node
          # verify contents (optional)
          tar -tzf $pkg
          echo "PACKAGE=$PWD/$pkg" >> $env:GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.check_version.outputs.version }}
          files: ${{ env.PACKAGE }}
        if: steps.check_version.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: prebuilds-${{ matrix.node }}-${{ matrix.arch }}
          path: ${{ env.PACKAGE }}
